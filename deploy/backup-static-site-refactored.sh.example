#!/bin/bash

# This script backs up the static website content from Azure Storage 
# to a local timestamped directory. It downloads all files from 
# the $web container and creates a manifest file with backup details.

# Load shared utilities
source "$(dirname "$0")/common.sh"

# Initialize
init_script
setup_logging "backup-static-site"

log "Starting static site backup"
log "Log file: $LOG_FILE"

# Validate environment
check_azure_cli
check_azure_login
load_resource_config
validate_config "STORAGE_ACCOUNT_NAME" "RESOURCE_GROUP"

# Display configuration
log_section "Static Site Backup Configuration"
log_config \
    "Storage Account" "$STORAGE_ACCOUNT_NAME" \
    "Resource Group" "$RESOURCE_GROUP"

# Validate resources exist
check_storage_account "$STORAGE_ACCOUNT_NAME" "$RESOURCE_GROUP"

# Create backup directory
BACKUP_DIR="$SCRIPT_DIR/../backups"
BACKUP_TIMESTAMP=$(date +%Y%m%d-%H%M%S)
BACKUP_PATH="$BACKUP_DIR/static-site-$BACKUP_TIMESTAMP"
mkdir -p "$BACKUP_PATH"

log "Backup directory: $BACKUP_PATH"

# Get storage account key
log "Retrieving storage account key..."
STORAGE_KEY=$(get_storage_key "$STORAGE_ACCOUNT_NAME" "$RESOURCE_GROUP")
log "Storage account key retrieved successfully"

# Download all blobs from the $web container
log ""
log "Downloading static site files from \$web container..."

az storage blob download-batch \
    --account-name "$STORAGE_ACCOUNT_NAME" \
    --account-key "$STORAGE_KEY" \
    --source '$web' \
    --destination "$BACKUP_PATH" >> "$LOG_FILE" 2>&1

if [ $? -eq 0 ]; then
    log "Files downloaded successfully"
else
    log "Error: Failed to download files. Check log file: $LOG_FILE"
    exit 1
fi

# Count files backed up
FILE_COUNT=$(find "$BACKUP_PATH" -type f | wc -l)
log ""
log "Backup completed: $FILE_COUNT files backed up"
log "Backup location: $BACKUP_PATH"

# Create a manifest file
MANIFEST_FILE="$BACKUP_PATH/MANIFEST.txt"
cat > "$MANIFEST_FILE" << EOF
Static Site Backup Manifest
============================
Backup Date: $(date '+%Y-%m-%d %H:%M:%S')
Storage Account: $STORAGE_ACCOUNT_NAME
Resource Group: $RESOURCE_GROUP
Files Backed Up: $FILE_COUNT
Container: \$web

Backup Details:
- Location: $BACKUP_PATH
- Total Size: $(du -sh "$BACKUP_PATH" | cut -f1)
EOF

log "Manifest created: $MANIFEST_FILE"
log ""
log "SUCCESS: Static site backup completed"
log "Backup saved to: $BACKUP_PATH"
log "Log saved to: $LOG_FILE"
